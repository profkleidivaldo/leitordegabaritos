<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>📄 Leitor de Gabaritos Inteligente — Versão Digital (Responsivo)</title>
<style>
body {
  font-family: Poppins, sans-serif;
  background: #f2f5fa;
  margin: 0;
  padding: 0;
  text-align: center;
}
h1 {
  background: #0056d2;
  color: white;
  padding: 10px 0;
  margin: 0;
}
nav {
  background: #e1e7f5;
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  padding: 10px;
}
nav button {
  background: #0056d2;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
}
nav button.active {
  background: #003e99;
}
section {
  display: none;
  padding: 20px;
}
.canvas-wrapper {
  width: 100%;
  max-width: 700px;
  margin: auto;
  position: relative;
}
canvas {
  border: 2px solid #0056d2;
  width: 100%;
  height: auto;
  touch-action: manipulation;
}
button, input[type=number], input[type=text] {
  font-size: 16px;
  margin: 6px;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #0056d2;
  color: white;
  cursor: pointer;
}
button:hover {
  background: #003e99;
}
#resultTable {
  width: 95%;
  margin: 20px auto;
  border-collapse: collapse;
  font-size: 14px;
}
#resultTable th, #resultTable td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
#resultTable th {
  background: #0056d2;
  color: white;
}
#resultadoAluno {
  margin-top: 20px;
  background: #e8f0ff;
  border-radius: 10px;
  padding: 10px;
  display: none;
  width: 90%;
  margin-left: auto;
  margin-right: auto;
}
#chartContainer {
  width: 90%;
  margin: 30px auto;
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
}
</style>
</head>
<body>
<h1>📄 Leitor de Gabaritos</h1>

<nav>
  <button id="tabProfessor" class="active">Professor</button>
  <button id="tabAluno">Estudante</button>
  <button id="tabResultados">Resultados</button>
</nav>

<section id="professor">
  <div>
    <label>Questões: <input type="number" id="numQ" value="10" min="1"></label>
    <label>Alternativas: <input type="number" id="numA" value="4" min="2" max="6"></label>
    <button id="buildBtn">Construir Gabarito</button>
  </div>
  <div class="canvas-wrapper"><canvas id="teacherCanvas" width="700"></canvas></div>
  <button id="markAnswersBtn">Marcar Respostas Corretas</button><br>
  <button id="baixarGabaritoProf">📥 Baixar Gabarito do Professor</button>
  <button id="baixarGabaritoAluno">📥 Baixar Gabarito do Aluno (em branco)</button>
</section>

<section id="aluno">
  <p>Digite seu nome e marque as respostas. Depois clique em <b>Corrigir</b>.</p>
  <input type="text" id="studentName" placeholder="Nome do estudante" style="width:60%;"><br>
  <div class="canvas-wrapper"><canvas id="studentCanvas" width="700"></canvas></div>
  <button id="corrigirBtn">Corrigir</button>
  <button id="novoAlunoBtn" style="display:none;">Novo Estudante</button>
  <div id="resultadoAluno"></div>
</section>

<section id="resultados">
  <h2>📊 Resultados da Turma</h2>
  <button id="baixarBtn">📥 Baixar Relatório (PDF)</button>
  <div id="chartContainer">
    <h3>📈 Acertos e Erros por Questão</h3>
    <canvas id="errosChart"></canvas>
  </div>
  <table id="resultTable">
    <thead id="resultHeader"></thead>
    <tbody></tbody>
  </table>
</section>

<!-- Dependências -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
let numQ = 10, numA = 4, gridInfo, teacherKey = [], studentAnswers = [];
let resultados = [];
const tCanvas = document.getElementById('teacherCanvas');
const sCanvas = document.getElementById('studentCanvas');
const ctx = tCanvas.getContext('2d');
const stx = sCanvas.getContext('2d');
let errosChart = null;

// === Troca de abas ===
function showTab(tab) {
  document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
  document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
  document.getElementById(tab).style.display = "block";
  document.getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");
}
document.getElementById('tabProfessor').onclick = () => showTab('professor');
document.getElementById('tabAluno').onclick = () => showTab('aluno');
document.getElementById('tabResultados').onclick = () => showTab('resultados');
showTab('professor');

// === Construir gabarito ===
document.getElementById('buildBtn').onclick = () => {
  numQ = parseInt(document.getElementById('numQ').value);
  numA = parseInt(document.getElementById('numA').value);
  const dynamicHeight = Math.max(400, 80 * numQ);
  tCanvas.height = dynamicHeight;
  sCanvas.height = dynamicHeight;
  gridInfo = buildGrid(numQ, numA);
  teacherKey = Array(numQ).fill(-1);
  studentAnswers = Array(numQ).fill(-1);
  drawGrid(ctx, gridInfo, teacherKey, true);
  drawGrid(stx, gridInfo, studentAnswers, true);
  atualizarCabecalhoTabela();
};

// === Criar posições ===
function buildGrid(numQ, numA) {
  const margin = 60, spacingY = 60, spacingX = 100;
  const positions = [];
  for (let i = 0; i < numQ; i++) {
    const row = [];
    for (let j = 0; j < numA; j++) {
      row.push({ cx: margin + spacingX * (j + 1), cy: margin + spacingY * (i + 1) });
    }
    positions.push(row);
  }
  return { numQ, numA, positions, circleR: 15 };
}

// === Desenhar ===
function drawGrid(context, info, keyArray, showLetters = false, colorArray = null) {
  context.clearRect(0, 0, context.canvas.width, context.canvas.height);
  context.fillStyle = "white";
  context.fillRect(0, 0, context.canvas.width, context.canvas.height);
  context.font = "16px Poppins";
  context.fillStyle = "black";
  context.textAlign = "center";

  info.positions.forEach((row, i) => {
    context.fillText(`${i + 1}.`, 30, row[0].cy + 5);
    row.forEach((p, j) => {
      context.beginPath();
      context.arc(p.cx, p.cy, info.circleR, 0, Math.PI * 2);
      context.strokeStyle = "#000";
      context.stroke();

      if (colorArray && colorArray[i] && colorArray[i][j]) {
        context.fillStyle = colorArray[i][j];
        context.beginPath();
        context.arc(p.cx, p.cy, info.circleR * 0.7, 0, Math.PI * 2);
        context.fill();
      } else if (keyArray[i] === j) {
        context.fillStyle = "#000";
        context.beginPath();
        context.arc(p.cx, p.cy, info.circleR * 0.7, 0, Math.PI * 2);
        context.fill();
      }
      if (showLetters)
        context.fillText(String.fromCharCode(65 + j), p.cx, p.cy - 20);
    });
  });
}

// === Coordenadas ===
function getCanvasPos(evt, canvas) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
  const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

// === Marcar respostas ===
tCanvas.addEventListener("pointerdown", e => markAnswer(e, tCanvas, ctx, teacherKey));
sCanvas.addEventListener("pointerdown", e => markAnswer(e, sCanvas, stx, studentAnswers));

function markAnswer(e, canvas, context, answersArray) {
  if (!gridInfo) return;
  const { x, y } = getCanvasPos(e, canvas);
  gridInfo.positions.forEach((row, i) => {
    row.forEach((p, j) => {
      if (Math.hypot(p.cx - x, p.cy - y) < gridInfo.circleR) {
        answersArray[i] = j;
        if (canvas === sCanvas) drawGrid(stx, gridInfo, studentAnswers, true);
        else drawGrid(ctx, gridInfo, teacherKey, true);
      }
    });
  });
}

// === Baixar gabaritos ===
document.getElementById("baixarGabaritoProf").onclick = () => baixarGabarito("professor");
document.getElementById("baixarGabaritoAluno").onclick = () => baixarGabarito("aluno");

function baixarGabarito(tipo) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  const canvas = document.createElement("canvas");
  canvas.width = tCanvas.width;
  canvas.height = tCanvas.height;
  const tempCtx = canvas.getContext("2d");

  if (tipo === "professor") {
    drawGrid(tempCtx, gridInfo, teacherKey, true);
    pdf.text("📘 Gabarito do Professor", 40, 40);
  } else {
    const vazio = Array(numQ).fill(-1);
    drawGrid(tempCtx, gridInfo, vazio, true);
    pdf.text("📄 Gabarito do Aluno (em branco)", 40, 40);
  }

  const img = canvas.toDataURL("image/png");
  pdf.addImage(img, "PNG", 40, 60, 500, 600);
  pdf.save(tipo === "professor" ? "gabarito_professor.pdf" : "gabarito_aluno.pdf");
}

// === Corrigir ===
document.getElementById('corrigirBtn').onclick = () => {
  const nome = document.getElementById("studentName").value.trim();
  const resultBox = document.getElementById("resultadoAluno");
  if (!nome) return alert("Por favor, digite o nome do estudante.");
  if (teacherKey.includes(-1)) return alert("O professor ainda não marcou todas as respostas.");

  const colorArray = [];
  let acertos = 0;
  for (let i = 0; i < numQ; i++) {
    colorArray[i] = [];
    for (let j = 0; j < numA; j++) {
      if (studentAnswers[i] === -1) colorArray[i][j] = "yellow";
      else if (teacherKey[i] === studentAnswers[i] && j === teacherKey[i]) {
        colorArray[i][j] = "limegreen"; acertos++;
      } else if (j === studentAnswers[i]) colorArray[i][j] = "red";
    }
  }
  drawGrid(stx, gridInfo, studentAnswers, true, colorArray);

  const nota = (10 * acertos / numQ).toFixed(2);
  resultados.push({ nome, respostas: [...studentAnswers], acertos, nota });
  atualizarTabelaResultados();
  atualizarGraficoErros();
  document.getElementById("novoAlunoBtn").style.display = "inline-block";
  resultBox.innerHTML = `<h3>Resultado de ${nome}</h3>
                         <p>Acertos: <b>${acertos}</b> de ${numQ}</p>
                         <p>Nota: <b>${nota}</b></p>`;
  resultBox.style.display = "block";
};

// === Novo estudante ===
document.getElementById('novoAlunoBtn').onclick = () => {
  studentAnswers = Array(numQ).fill(-1);
  drawGrid(stx, gridInfo, studentAnswers, true);
  document.getElementById("studentName").value = "";
  document.getElementById("resultadoAluno").style.display = "none";
  document.getElementById("novoAlunoBtn").style.display = "none";
};

// === Tabela ===
function atualizarCabecalhoTabela() {
  const header = document.getElementById("resultHeader");
  let html = "<tr><th>Nome</th>";
  for (let i = 1; i <= numQ; i++) html += `<th>Q${i}</th>`;
  html += "<th>Acertos</th><th>Nota</th></tr>";
  header.innerHTML = html;
}

function atualizarTabelaResultados() {
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  resultados.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><b>${r.nome}</b></td>`;
    for (let i = 0; i < numQ; i++) {
      let simbolo = "-";
      if (r.respostas[i] === -1) simbolo = "-";
      else if (r.respostas[i] === teacherKey[i]) simbolo = "✔️";
      else simbolo = "❌";
      tr.innerHTML += `<td>${simbolo}</td>`;
    }
    tr.innerHTML += `<td>${r.acertos}</td><td>${r.nota}</td>`;
    tbody.appendChild(tr);
  });
}

// === Gráfico ===
function atualizarGraficoErros() {
  if (!resultados.length) return;
  const errosPorQuestao = Array(numQ).fill(0);
  const acertosPorQuestao = Array(numQ).fill(0);
  resultados.forEach(r => {
    for (let i = 0; i < numQ; i++) {
      if (r.respostas[i] === teacherKey[i]) acertosPorQuestao[i]++;
      else errosPorQuestao[i]++;
    }
  });
  const ctxChart = document.getElementById("errosChart").getContext("2d");
  const labels = errosPorQuestao.map((_, i) => `Q${i+1}`);
  if (errosChart) errosChart.destroy();
  errosChart = new Chart(ctxChart, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        { label: "Acertos", data: acertosPorQuestao, backgroundColor: "limegreen" },
        { label: "Erros", data: errosPorQuestao, backgroundColor: "red" }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

// === PDF com tabela formatada ===
document.getElementById("baixarBtn").onclick = async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

  pdf.setFontSize(16);
  pdf.text("📊 Relatório de Resultados da Turma", 40, 40);

  const chartCanvas = document.getElementById("errosChart");
  const chartImg = chartCanvas.toDataURL("image/png");
  pdf.addImage(chartImg, "PNG", 40, 60, 500, 200);

  pdf.setFontSize(12);
  pdf.text("Tabela de Desempenho:", 40, 290);

  const table = document.getElementById("resultTable");
  const headers = Array.from(table.rows[0].cells).map(c => c.innerText);
  const rows = Array.from(table.rows)
    .slice(1)
    .map(row => Array.from(row.cells).map(c => c.innerText));

  pdf.autoTable({
    startY: 310,
    head: [headers],
    body: rows,
    theme: "grid",
    styles: { fontSize: 10, cellPadding: 4, halign: "center" },
    headStyles: { fillColor: [0, 86, 210], textColor: 255, fontStyle: "bold" },
    margin: { left: 40, right: 40 },
  });

  pdf.save("resultados.pdf");
};
</script>
</body>
</html>
